# MaterScript Overview
### A new IoT scripting language
> Caution: MaterScript is very much a work in progress. You can do a few things with it, like get the current time and print on Mac. But it's not up on ESP8266 yet and for all I know may never be. Right now it's just a proof of concept. Proceed at your own risk.

MaterScript is a language I've been working on as part of my [Marrinator](https://github.com/cmarrin/marrinator) project. I was making it as a small scripting language for Arduino, but quickly realized that even the tiniest scripting language was going to have trouble on such a small platform, mostly due to the tiny data space.

Now that I'm playing with the ESP8266, I've picked it up again. Why? There are already tons of scripting languages out there. But almost all are an attempt at making a tiny version of an existing complete language (Lua, JavaScript, Python). The result is either a crippled version or one that just barely fits in memory and crashes regularly.

I wanted to make a new language whose capabilities were tuned to the capabilities of the platform. I also wanted to make one that had familiar syntax (e.g., JavaScript) and modern features (e.g., OOP, block scoping). But which didn't try to duplicate all the features of a language like JavaScript or Python. These languages have great features and run well on full size computers. But on a small, memory constrained platform, especially one that uses Harvard Architecture, you need to trim down the features and expectations of the language.

### The Basics
MaterScript is written in C++11, which works well with the toolchains I'm using. It can run on Mac, using the XCode project file, or ESP8266, using the supplied Makefile. It has a separate Parser class which generates a Program object (which will eventually be serializable). And a separate ExecutionUnit which can execute the Program object. You can include one or both, depending on your footprint requirements. And that's the first tradeoff. MaterScript neither has nor depends on built-in source compilation (e.g., eval()). Perhaps I'll add an optional object that will supply this feature, but it will be optional.

### Issues
MaterScript is really small. An empty ESP8266 app takes up 217K of flash and 26K of data. The ExecutionUnit and all its support is currently running at around 8K of flash and 2K of data. The Parser is bigger. It's 23K of flash and 11K of data. The Parser is generated from Bison and that is causing the problem due to the system's Harvard Architecture. The problem is that Bison is table driven. That makes it super fast but those tables have to go into data memory, 11K worth in the current version. There may be some tricks that can be played, but AFAIK these require decorating the arrays, which are generated by Bison. So that would be a huge hassle.

So I've started hand coding a recursive decent parser, which can be done with hardly any data storage other than the stack. A very rudimentary version is working and is saving about 6K of that 11K of data. And there are still optimization to be done.

### Memory sizes
The table below shows the current size of the code (as of 6/21/16). The ParseEngine based parser saves considerably on ram usage over the yyparse based parser.

|                   |                                     | Flash   | Ram    | Remaining Ram |
|-------------------|-------------------------------------|---------|--------|---------------|
| Total Memory Used | yyParse/Parser                      | 22,608  | 9,272  |               |
|                   | ParseEngine/Parser                  | 20,420  | 4,468  |               |
|                   | yyParse/GenString                   | 5,532   | 2,676  |               |
|                   | yyParse/EU                          | 7,656   | 1,616  |               |
|                   |                                     |         |        |               |
|                   | Savings of ParseEngine over yyparse | 2,188   | 4,804  |               |
|                   |                                     |         |        |               |
|                   | EU only size                        | 7,656   | 1,616  | 49,148        |
|                   | Parse Engine Parser + EU size       | 28,076  | 6,084  | 44,680        |